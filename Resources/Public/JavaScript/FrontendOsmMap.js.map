{"version":3,"sources":["FrontendOsmMap.ts"],"names":[],"mappings":"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","file":"FrontendOsmMap.js","sourcesContent":["/**\n * This file is developed by evoweb.\n *\n * It is free software; you can redistribute it and/or modify it under\n * the terms of the GNU General Public License, either version 2\n * of the License, or any later version.\n *\n * For the full copyright and license information, please read the\n * LICENSE.txt file that was distributed with this source code.\n */\n\n/// <reference types=\"../types/index\" />\nimport * as Mustache from 'mustache';\nimport * as $ from 'jquery';\nimport * as L from 'leaflet';\nimport {MapConfiguration, Location} from \"./Interfaces\";\n\nclass Marker extends L.Marker {\n  public sfLocation: Location;\n}\n\n/**\n * Module: TYPO3/CMS/StoreFinder/FrontendOsmMap\n * contains all logic for the frontend map output\n * @exports TYPO3/CMS/StoreFinder/FrontendOsmMap\n */\nclass FrontendMap {\n  private map: L.Map;\n  private mapConfiguration: MapConfiguration;\n  private locations: Array<Location>;\n  private locationIndex: number = 0;\n  private infoWindow: L.Popup;\n  private infoWindowTemplate: string;\n  private templateParser: any;\n\n  /**\n   * The constructor, set the class properties default values\n   */\n  constructor(mapConfiguration: MapConfiguration, locations: Array<Location>) {\n    this.mapConfiguration = mapConfiguration || {\n      active: false,\n      afterSearch: 0,\n\n      apiConsoleKey: '',\n      apiUrl: '',\n      allowSensors: false,\n      language: 'en',\n\n      markerIcon: '',\n      apiV3Layers: '',\n      kmlUrl: '',\n      renderSingleViewCallback: null,\n      handleCloseButtonCallback: null\n    };\n    this.locations = locations;\n\n    this.loadScript();\n  }\n\n  /**\n   * Initialize map\n   */\n  initializeMap() {\n    let self = this;\n\n    self.map = L.map('tx_storefinder_map');\n\n    if (typeof this.mapConfiguration.center !== 'undefined') {\n      this.map.setView(\n        [self.mapConfiguration.center.lat, self.mapConfiguration.center.lng],\n        parseInt(self.mapConfiguration.zoom, 10)\n      );\n    } else {\n      this.map.setView([0, 0], 13);\n    }\n\n    // more providers can be found here http://leaflet-extras.github.io/leaflet-providers/preview/\n    L.tileLayer(\n      'https://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}', {\n        maxZoom: 20,\n        attribution: 'Imagery from <a href=\"http://giscience.uni-hd.de/\">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n      }\n    ).addTo(self.map);\n  }\n\n  /**\n   * Initialize information layer on map\n   */\n  initializeLayer(this: FrontendMap) {\n    /*if (this.mapConfiguration.apiV3Layers.indexOf('traffic') > -1) {\n      let trafficLayer = new google.maps.TrafficLayer();\n      trafficLayer.setMap(this.map);\n    }\n\n    if (this.mapConfiguration.apiV3Layers.indexOf('bicycling') > -1) {\n      let bicyclingLayer = new google.maps.BicyclingLayer();\n      bicyclingLayer.setMap(this.map);\n    }\n\n    if (this.mapConfiguration.apiV3Layers.indexOf('panoramio') > -1) {\n      let panoramioLayer = new google.maps.panoramio.PanoramioLayer();\n      panoramioLayer.setMap(this.map);\n    }\n\n    if (this.mapConfiguration.apiV3Layers.indexOf('weather') > -1) {\n      let weatherLayer = new google.maps.weather.WeatherLayer({\n        temperatureUnits: google.maps.weather.TemperatureUnit.DEGREE\n      });\n      weatherLayer.setMap(this.map);\n    }*/\n\n    if (this.mapConfiguration.apiV3Layers.indexOf('kml') > -1) {\n      let $jsDeferred = $.Deferred(),\n        $jsFile = $('<script/>', {\n          src: 'https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js',\n          crossorigin: ''\n        }).appendTo('head');\n\n      $jsDeferred.resolve($jsFile);\n\n      let self = this;\n      $.when($jsDeferred.promise()).done(function () {\n        let kmlLayer = omnivore.kml(self.mapConfiguration.kmlUrl);\n        kmlLayer.setMap(self.map);\n      }).fail(function () {\n        console.log('Failed loading resources.');\n      });\n    }\n  }\n\n  /**\n   * Close previously open info window, renders new content and opens the window\n   *\n   * @param {object} marker\n   */\n  showInformation(this: FrontendMap, marker: Marker) {\n    let location = marker.sfLocation;\n\n    if (typeof this.mapConfiguration.renderSingleViewCallback === 'function') {\n      this.mapConfiguration.renderSingleViewCallback(location, this.infoWindowTemplate);\n    } else {\n      if (this.infoWindow.isOpen()) {\n        this.infoWindow.closePopup();\n      }\n\n      this.infoWindow = marker.getPopup()\n        .setContent(Mustache.render(this.infoWindowTemplate, location.information))\n        .setLatLng(L.latLng(location.lat, location.lng))\n        .openOn(this.map);\n    }\n  }\n\n  /**\n   * Process single location\n   *\n   * @param location\n   */\n  processLocation(this: FrontendMap, location: Location) {\n    let icon = '';\n    if (location.information.icon) {\n      icon = location.information.icon;\n    } else if (this.mapConfiguration.hasOwnProperty('markerIcon')) {\n      icon = this.mapConfiguration.markerIcon;\n    }\n\n    this.locationIndex++;\n    location.information.index = this.locationIndex;\n\n    let marker = new Marker([location.lat, location.lng], {\n      title: location.name,\n      icon: L.icon({iconUrl: icon}),\n    });\n    marker.sfLocation = location;\n    marker.bindPopup('').addTo(this.map);\n\n    marker.on('click', () => {\n      this.showInformation(marker);\n    });\n\n    // attach marker to location to be able to close it later\n    location.marker = marker;\n  }\n\n  /**\n   * Initialize location marker on map\n   */\n  initializeLocations(this: FrontendMap) {\n    this.locations.map(this.processLocation.bind(this));\n  }\n\n  /**\n   * Initialize instance of map infoWindow\n   */\n  initializeInfoWindow() {\n    this.infoWindow = L.popup();\n  }\n\n  /**\n   * Initialize info window template\n   */\n  initializeTemplates(this: FrontendMap) {\n    this.infoWindowTemplate = $('#templateInfoWindow').html();\n    Mustache.parse(this.infoWindowTemplate);\n\n    $(document).on('click', '.tx-storefinder .infoWindow .close', (event: Event, $closeButton: JQuery): void => {\n      if (typeof this.mapConfiguration.renderSingleViewCallback === 'function') {\n        this.mapConfiguration.handleCloseButtonCallback($closeButton);\n      } else {\n        this.infoWindow.closePopup();\n      }\n    });\n  }\n\n  /**\n   * Trigger click event on marker on click in result list\n   */\n  openInfoWindow(this: FrontendMap, index: number) {\n    this.locations[index].marker.fire('click');\n  }\n\n  /**\n   * Initialize list click events\n   */\n  initializeListEvents(this: FrontendMap) {\n    $(document).on('click', '.tx-storefinder .resultList > li', (event: Event, $field: JQuery): void => {\n      this.openInfoWindow($field.data('index'));\n    });\n  }\n\n  /**\n   * Post load javascript files\n   */\n  postLoadScript() {\n    this.initializeMap();\n    this.initializeLayer();\n    this.initializeLocations();\n    this.initializeInfoWindow();\n    this.initializeTemplates();\n    this.initializeListEvents();\n  }\n\n  /**\n   * Load open street map leaflet script\n   */\n  loadScript() {\n    let self = this,\n      $cssDeferred = $.Deferred(),\n      $cssFile = $('<link/>', {\n        rel: 'stylesheet',\n        type: 'text/css',\n        href: 'https://unpkg.com/leaflet@1.3.4/dist/leaflet.css',\n        integrity: 'sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==',\n        crossorigin: ''\n      }).appendTo('head'),\n      $jsDeferred = $.Deferred(),\n      $jsFile = $('<script/>', {\n        src: 'https://unpkg.com/leaflet@1.3.4/dist/leaflet.js',\n        integrity: 'sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==',\n        crossorigin: ''\n      }).appendTo('head');\n\n    $cssDeferred.resolve($cssFile);\n    $jsDeferred.resolve($jsFile);\n\n    $.when(\n      $cssDeferred.promise(),\n      $jsDeferred.promise()\n    ).done(function () {\n      function wait(this: FrontendMap) {\n        if (typeof window.L !== 'undefined') {\n          this.postLoadScript();\n        } else {\n          window.requestAnimationFrame(wait.bind(this));\n        }\n      }\n      window.requestAnimationFrame(wait.bind(self));\n    }).fail(function () {\n      console.log('Failed loading resources.');\n    });\n  }\n}\n\n$(document).ready(function () {\n  if (typeof window.mapConfiguration == 'object' && window.mapConfiguration.active) {\n    // make module public to be available for callback after load\n    window.StoreFinder = new FrontendMap(window.mapConfiguration, window.locations);\n  }\n});\n\n// return constructor\nexport = FrontendMap;\n"]}